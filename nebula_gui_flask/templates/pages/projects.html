{% extends "layout.html" %}
{#
  nebula_gui_flask/templates/pages/projects.html
  Copyright (c) 2026 Monolink Systems
  Licensed under AGPLv3 (Nebula Open Source Edition, non-corporate)
#}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/containers.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/projects.css') }}">
{% endblock %}

{% block page_content %}
<div class="container-fluid" style="padding: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; gap: 16px;">
        <div>
            <h2 style="font-weight: 700; color: white; margin: 0;">Project Management</h2>
            <div class="project-tabs" style="margin-top: 20px;">
                <button type="button" id="tab_active" class="tab-item active" onclick="setProjectTab('active')"><i class="bi bi-lightning-charge"></i> Active</button>
                <button type="button" id="tab_archived" class="tab-item" onclick="setProjectTab('archived')"><i class="bi bi-archive"></i> Archived</button>
                <div class="tab-item is-disabled" title="Backups are not implemented yet"><i class="bi bi-cloud-download"></i> Backups</div>
            </div>
        </div>
        {% if session.get('is_staff') %}
        <button onclick="openCreateProjectModal()" class="add-user-btn" style="border: none; cursor: pointer;">
            <i class="bi bi-plus-lg"></i> <span>Create Project</span>
        </button>
        {% endif %}
    </div>

    <div class="table-card">
        <div class="project-filter-bar project-filter-grid" style="padding: 14px 20px; border-bottom: 1px solid var(--border); display:grid; grid-template-columns: 1.4fr 1fr 1fr; gap: 10px;">
            <div class="input-wrapper">
                <i class="bi bi-search"></i>
                <input id="project_search" type="text" placeholder="Search project by name, description, tag..." oninput="onProjectFiltersChanged()">
            </div>
            <div class="input-wrapper">
                <i class="bi bi-sort-down"></i>
                <select id="project_sort" onchange="onProjectFiltersChanged()">
                    <option value="load_desc">Load: high to low</option>
                    <option value="load_asc">Load: low to high</option>
                    <option value="name_asc">Name: A-Z</option>
                    <option value="name_desc">Name: Z-A</option>
                    <option value="updated_desc">Recently updated</option>
                </select>
            </div>
            <div class="input-wrapper">
                <i class="bi bi-hash"></i>
                <select id="project_tag_filter" onchange="onProjectFiltersChanged()">
                    <option value="">All tags</option>
                </select>
            </div>
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr class="table-header-row">
                    <th style="padding: 18px 24px; width: 50px;"></th>
                    <th style="padding: 18px 24px;">Project Name</th>
                    <th style="padding: 18px 24px;">Team</th>
                    <th style="padding: 18px 24px;">Total Load</th>
                    <th style="padding: 18px 24px; text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody id="projects_tbody">
                <tr>
                    <td colspan="5" style="padding: 20px 24px; color: var(--text-muted);">Loading projects...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

{% if session.get('is_staff') %}
<div id="createModal" class="modal-overlay">
    <div class="modal-content" style="width: 500px;">
        <div class="modal-header">
            <h3 style="margin:0; color: white;">New Project</h3>
            <button onclick="closeModal('createModal')" class="close-modal-btn">&times;</button>
        </div>
        <div style="padding: 24px;">
            <div class="input-field">
                <label>Project Name</label>
                <div class="input-wrapper"><i class="bi bi-tag"></i><input type="text" id="create_project_name" placeholder="e.g. SkyNet Core"></div>
            </div>
            <div class="input-field" style="margin-top: 15px;">
                <label>Description</label>
                <div class="input-wrapper"><i class="bi bi-text-left"></i><textarea id="create_project_desc" rows="3" placeholder="Project goals..."></textarea></div>
            </div>
            <div class="input-field" style="margin-top: 15px;">
                <label>Tags (Comma separated)</label>
                <div class="input-wrapper"><i class="bi bi-hash"></i><input id="create_project_tags" type="text" placeholder="prod, internal, web"></div>
            </div>
            <div class="input-field" style="margin-top: 15px;">
                <label>Link Containers (Optional)</label>
                <div class="input-wrapper"><i class="bi bi-search"></i><input id="create_container_search" type="text" placeholder="Search container..." oninput="renderCreateContainerList()"></div>
                <div id="create_container_list" class="users-list" style="max-height: 210px; margin-top: 10px;"></div>
                <div id="create_container_selected" class="selected-users" style="margin-top: 10px;"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('createModal')" class="btn-secondary">Cancel</button>
            <button id="create_project_btn" onclick="submitCreateProject()" class="btn-primary">Create</button>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-content" style="width: 500px;">
        <div class="modal-header">
            <h3 style="margin:0; color: white;">Project Settings</h3>
            <button onclick="closeModal('settingsModal')" class="close-modal-btn">&times;</button>
        </div>
        <div style="padding: 24px;">
            <input type="hidden" id="edit_project_id">
            <div class="input-field">
                <label>Edit Name</label>
                <div class="input-wrapper"><i class="bi bi-pencil"></i><input id="edit_project_name" type="text"></div>
            </div>
            <div class="input-field" style="margin-top: 15px;">
                <label>Edit Description</label>
                <div class="input-wrapper"><i class="bi bi-justify-left"></i><textarea id="edit_project_desc" rows="3"></textarea></div>
            </div>
            <div class="input-field" style="margin-top: 15px;">
                <label>Tags</label>
                <div class="input-wrapper"><i class="bi bi-hash"></i><input id="edit_project_tags" type="text"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('settingsModal')" class="btn-secondary">Discard</button>
            <button id="save_project_btn" onclick="submitProjectUpdate()" class="btn-primary">Save Changes</button>
        </div>
    </div>
</div>

<div id="linkContainerModal" class="modal-overlay">
    <div class="modal-content" style="width: 560px;">
        <div class="modal-header">
            <h3 style="margin:0; color: white;">Link Container</h3>
            <button onclick="closeModal('linkContainerModal')" class="close-modal-btn">&times;</button>
        </div>
        <div style="padding: 24px;">
            <div class="input-field">
                <label>Search container by name</label>
                <div class="input-wrapper"><i class="bi bi-search"></i><input id="link_container_search" type="text" placeholder="container name" oninput="renderLinkContainerList()"></div>
            </div>
            <div id="link_container_list" class="users-list" style="max-height: 320px; margin-top: 14px;"></div>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal('linkContainerModal')" class="btn-secondary">Close</button>
        </div>
    </div>
</div>
{% endif %}

<div id="teamModal" class="modal-overlay">
    <div class="modal-content" style="width: 420px;">
        <div class="modal-header">
            <h3 id="team_modal_title" style="margin:0; color: white;">Project Team</h3>
            <button onclick="closeModal('teamModal')" class="close-modal-btn">&times;</button>
        </div>
        <div style="padding: 20px;">
            <div id="team_modal_users" class="users-list"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script nonce="{{ csp_nonce }}">
window.NebulaProjects = {
    isStaff: {{ 'true' if session.get('is_staff') else 'false' }}
};
</script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='js/pages/projects.js') }}"></script>
{% endblock %}
