{% extends "layout.html" %}
{#
  nebula_gui_flask/templates/pages/containers.html
  Copyright (c) 2026 Monolink Systems
  Licensed under AGPLv3 (Nebula Open Source Edition, non-corporate)
#}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/containers.css') }}">
{% endblock %}
{% block extra_js %}
<script nonce="{{ csp_nonce }}">
window.NebulaContainers = {
    isStaff: {{ 'true' if session.get('is_staff') else 'false' }}
};
</script>
<script nonce="{{ csp_nonce }}" src="{{ url_for('static', filename='js/pages/containers.js') }}"></script>
{% endblock %}
{% block page_content %}

<div class="container-fluid" style="padding: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
        <div style="display: flex; align-items: center; gap: 24px;">
            <h2 style="font-weight: 700; letter-spacing: -0.5px; margin: 0; color: white;">Container Orchestration</h2>
            {% if session.get('is_staff') %}
            <div style="position: relative;">
                <i class="bi bi-cpu" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem;"></i>
                <select id="node_selector" onchange="onNodeChanged()" class="premium-select">
                </select>
                <i class="bi bi-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.8rem; pointer-events: none;"></i>
            </div>
            {% endif %}
        </div>
        {% if session.get('is_staff') %}
        <button onclick="openCreateModal()" class="add-user-btn" style="border: none; cursor: pointer;">
            <i class="bi bi-box-seam-fill"></i>
            <span>Deploy Container</span>
        </button>
        {% endif %}
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(210px, 1fr)); gap: 20px; margin-bottom: 32px;">
        <div class="stat-card">
            <div class="stat-label">Active Containers</div>
            <div id="stat_active_containers" class="stat-value">— <span class="stat-sub">running / total</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total RAM Usage</div>
            <div id="stat_ram" class="stat-value">— <span class="stat-sub">/ —</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Active CPU Cores</div>
            <div id="stat_cpu" class="stat-value">— <span class="stat-sub">/ —</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Network Load</div>
            <div id="stat_net" class="stat-value">— <span class="stat-sub">Mb/s</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">System Health</div>
            <div id="stat_health" class="stat-value health-optimal">Optimal <span id="stat_health_sub" class="stat-sub">pressure low</span></div>
        </div>
    </div>

    <div class="table-card">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr class="table-header-row">
                    <th style="padding: 18px 24px;">Container Identity</th>
                    <th style="padding: 18px 24px;">Image / Environment</th>
                    <th style="padding: 18px 24px;">Projects</th>
                    <th style="padding: 18px 24px;">Assigned Users</th>
                    <th style="padding: 18px 24px;">Uptime / Status</th>
                    <th style="padding: 18px 24px; text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody id="container_table_body">
            </tbody>
        </table>
    </div>
</div>

<div id="consoleModal" class="modal-overlay">
    <div class="modal-content" style="width: 980px;">
        <div class="modal-header">
            <div>
                <h3 id="consoleTitle" style="margin: 0; font-weight: 700; color: white;">Container Console</h3>
                <p id="consoleSub" style="margin: 4px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">Live log stream</p>
            </div>
            <button onclick="closeConsoleModal()" class="close-modal-btn"><i class="bi bi-x-lg"></i></button>
        </div>
        <div style="padding: 20px 24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <div id="consoleStatus" style="font-size:0.8rem; color: var(--text-muted);">Waiting for logs...</div>
                <button class="btn-secondary" style="padding:8px 14px;" onclick="refreshConsoleLogs()">
                    <i class="bi bi-arrow-repeat"></i> Refresh
                </button>
            </div>
            <pre id="consoleOutput" style="margin:0; max-height: 55vh; overflow:auto; padding:14px; border:1px solid var(--border); border-radius:12px; background:#060609; color:#d6d6de; font-size:0.78rem; line-height:1.45;"></pre>
        </div>
    </div>
</div>

{% if session.get('is_staff') %}
<div id="containerModal" class="modal-overlay">
    <div class="modal-content" style="width: 850px;">
        <div class="modal-header">
            <div>
                <h3 id="modalTitle" style="margin: 0; font-weight: 700; color: white;">Container Architect</h3>
                <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">Define execution parameters and resource limits</p>
            </div>
            <button onclick="closeModal()" class="close-modal-btn"><i class="bi bi-x-lg"></i></button>
        </div>

        <div style="padding: 32px; max-height: 70vh; overflow-y: auto;">
            <div class="preset-block">
                <div class="preset-title">Deployment Presets</div>
                <div class="preset-grid" style="grid-template-columns: 1fr auto;">
                    <select id="cont_preset_select" class="premium-select" style="min-width:0; width:100%; padding-left:12px;">
                    </select>
                    <button type="button" class="btn-secondary" style="padding: 10px 14px;" onclick="applySelectedPreset()">
                        <i class="bi bi-check2-square"></i> Apply
                    </button>
                </div>
                <div class="preset-grid" style="grid-template-columns: 1fr 1fr auto; margin-top: 8px;">
                    <input type="text" id="preset_save_name" placeholder="my-custom-preset" style="width:100%; padding: 10px 12px; background:#050507; border:1px solid var(--border); border-radius: 10px; color:white;">
                    <input type="text" id="preset_save_title" placeholder="Custom title (optional)" style="width:100%; padding: 10px 12px; background:#050507; border:1px solid var(--border); border-radius: 10px; color:white;">
                    <button type="button" class="btn-primary" style="padding: 10px 14px;" onclick="saveCurrentAsPreset()">
                        <i class="bi bi-floppy"></i> Save
                    </button>
                </div>
                <div id="preset_hint" class="preset-hint">Select preset from containers/presets.</div>
            </div>

            <div class="modal-grid">
                <div class="modal-col">
                    <div class="input-field">
                        <label>Instance Name</label>
                        <div class="input-wrapper">
                            <i class="bi bi-tag"></i>
                            <input type="text" id="cont_name" placeholder="e.g. production-api-01">
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Docker Image</label>
                        <div class="input-wrapper">
                            <i class="bi bi-database-down"></i>
                            <input type="text" id="cont_image" placeholder="ubuntu:latest">
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Assigned Operators</label>
                        <div class="user-picker">
                            <div class="input-wrapper">
                                <i class="bi bi-search"></i>
                                <input type="text" id="cont_user_search" placeholder="Search user..." oninput="renderUserPicker(this.value)">
                            </div>
                            <div id="cont_users_list" class="users-list"></div>
                            <div id="cont_users_selected" class="selected-users"></div>
                        </div>
                        <span class="input-hint" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; display: block;">Select users who can view/manage this container</span>
                    </div>
                    <div class="input-field">
                        <label>Assign To Projects</label>
                        <div class="input-wrapper">
                            <i class="bi bi-kanban"></i>
                            <select id="cont_project_ids" multiple style="min-height: 120px;">
                            </select>
                        </div>
                        <span class="input-hint" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; display: block;">Optional: select one or more projects to link right after deploy</span>
                    </div>
                </div>

                <div class="modal-col">
                    <div class="input-field">
                        <label>Memory Limit (MB)</label>
                        <div class="input-wrapper">
                            <i class="bi bi-memory"></i>
                            <input type="number" id="cont_ram_input" value="512" min="64">
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Swap Limit (MB)</label>
                        <div class="input-wrapper">
                            <i class="bi bi-layers-half"></i>
                            <input type="number" id="cont_swap" value="1024" min="0">
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Writable Disk (GB)</label>
                        <div class="input-wrapper">
                            <i class="bi bi-device-hdd"></i>
                            <input type="number" id="cont_disk" value="10" min="0">
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Port Mapping</label>
                        <div class="input-wrapper">
                            <i class="bi bi-ethernet"></i>
                            <input type="text" id="cont_ports" placeholder="8080:80, 8443:443, 127.0.0.1:2222:22">
                        </div>
                    </div>
                    <div class="input-field">
                        <label>CPU Weight</label>
                        <div class="input-wrapper">
                            <i class="bi bi-speedometer2"></i>
                            <input type="number" id="cont_cpu" value="1024" min="2" max="262144">
                        </div>
                    </div>
                    <div class="input-field">
                        <label>CPU Limit (cores)</label>
                        <div class="input-wrapper">
                            <i class="bi bi-cpu"></i>
                            <input type="number" id="cont_cpu_limit" value="1.0" min="0.1" step="0.1">
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Pin CPU Cores (cpuset)</label>
                        <div class="input-wrapper">
                            <i class="bi bi-diagram-3"></i>
                            <input type="text" id="cont_cpuset" placeholder="0-1 or 0,2,4">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="input-field">
                            <label>CPU Quota</label>
                            <div class="input-wrapper">
                                <i class="bi bi-sliders2"></i>
                                <input type="number" id="cont_cpu_quota" placeholder="100000" min="0">
                            </div>
                        </div>
                        <div class="input-field">
                            <label>CPU Period</label>
                            <div class="input-wrapper">
                                <i class="bi bi-sliders2-vertical"></i>
                                <input type="number" id="cont_cpu_period" placeholder="100000" min="0">
                            </div>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="input-field">
                            <label>PIDs Limit</label>
                            <div class="input-wrapper">
                                <i class="bi bi-list-ol"></i>
                                <input type="number" id="cont_pids_limit" placeholder="256" min="0">
                            </div>
                        </div>
                        <div class="input-field">
                            <label>/dev/shm (MB)</label>
                            <div class="input-wrapper">
                                <i class="bi bi-hdd-rack"></i>
                                <input type="number" id="cont_shm" value="64" min="16">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 24px; display:grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div class="input-field">
                    <label>Startup Command</label>
                    <div class="input-wrapper">
                        <i class="bi bi-terminal"></i>
                        <input type="text" id="cont_command" placeholder="e.g. python app.py --port 80">
                    </div>
                </div>
                <div class="input-field">
                    <label>Environment Variables (KEY=VALUE)</label>
                    <div class="input-wrapper">
                        <i class="bi bi-braces"></i>
                        <textarea id="cont_env" rows="4" placeholder="APP_ENV=prod&#10;LOG_LEVEL=info"></textarea>
                    </div>
                </div>
            </div>
            <div class="input-field" style="margin-top: 16px;">
                <label>Volume Mounts (/host:/container[:ro|rw])</label>
                <div class="input-wrapper">
                    <i class="bi bi-folder-symlink"></i>
                    <textarea id="cont_volumes" rows="4" placeholder="/srv/app/data:/app/data:rw&#10;/srv/app/config:/app/config:ro"></textarea>
                </div>
            </div>
            <div class="input-field" style="margin-top: 16px;">
                <label>Role Permissions</label>
                <div id="role_permissions_grid" style="border:1px solid var(--border); border-radius: 12px; overflow:auto; background:#07070b;"></div>
                <span class="input-hint" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; display: block;">Permissions apply to roles from `/roles/list` and are inherited by users via their `role_tag`.</span>
            </div>

            <div class="status-box">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="status-icon-bg" style="background: rgba(74, 222, 128, 0.1); color: #4ade80;">
                        <i class="bi bi-rocket-takeoff"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600; font-size: 0.9rem; color: white;">Auto-Restart Policy</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Restart container on crash or system reboot</div>
                    </div>
                </div>
                <label class="ios-switch">
                    <input type="checkbox" id="cont_restart" checked>
                    <span class="ios-slider"></span>
                </label>
            </div>
        </div>

        <div class="modal-footer">
            <button onclick="closeModal()" class="btn-secondary">Discard</button>
            <button onclick="saveContainer()" class="btn-primary" id="saveBtn">Deploy Instance</button>
        </div>
    </div>
</div>
{% endif %}

{% if session.get('is_staff') %}
<div id="containerSettingsModal" class="modal-overlay">
    <div class="modal-content" style="width: 920px;">
        <div class="modal-header">
            <div>
                <h3 id="settingsModalTitle" style="margin: 0; font-weight: 700; color: white;">Container Settings</h3>
                <p id="settingsModalSub" style="margin: 4px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">Update container access and runtime settings</p>
            </div>
            <button onclick="closeContainerSettingsModal()" class="close-modal-btn"><i class="bi bi-x-lg"></i></button>
        </div>
        <div style="padding: 24px 28px; max-height: 72vh; overflow-y: auto;">
            <div style="display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; margin-bottom: 18px;">
                <div class="input-field">
                    <label>Container Name</label>
                    <div class="input-wrapper">
                        <i class="bi bi-box-seam"></i>
                        <input type="text" id="edit_cont_name" readonly>
                    </div>
                </div>
                <div class="input-field">
                    <label>Container ID</label>
                    <div class="input-wrapper">
                        <i class="bi bi-hash"></i>
                        <input type="text" id="edit_cont_id" readonly>
                    </div>
                </div>
                <div class="input-field">
                    <label>Image</label>
                    <div class="input-wrapper">
                        <i class="bi bi-database-down"></i>
                        <input type="text" id="edit_cont_image" readonly>
                    </div>
                </div>
            </div>

            <div style="margin-top: 10px; display:grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div class="input-field">
                    <label>Startup Command</label>
                    <div class="input-wrapper">
                        <i class="bi bi-terminal"></i>
                        <input type="text" id="edit_cont_command" placeholder="e.g. ./start.sh --env prod">
                    </div>
                </div>
                <div class="input-field">
                    <label>Allowed Ports</label>
                    <div class="input-wrapper">
                        <i class="bi bi-ethernet"></i>
                        <input type="text" id="edit_cont_ports" placeholder="8080:80, 8443:443, 27015:27015/udp">
                    </div>
                </div>
            </div>

            <div style="margin-top: 14px; display:grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div class="input-field">
                    <label>Restart Policy</label>
                    <div class="input-wrapper">
                        <i class="bi bi-arrow-repeat"></i>
                        <select id="edit_restart_policy" style="width:100%; padding: 14px 16px 14px 46px; background:#050507; border:1px solid var(--border); border-radius: 12px; color:white;">
                            <option value="no">no</option>
                            <option value="always">always</option>
                            <option value="unless-stopped">unless-stopped</option>
                            <option value="on-failure">on-failure</option>
                        </select>
                    </div>
                </div>
                <div class="input-field">
                    <label>Max Retry Count</label>
                    <div class="input-wrapper">
                        <i class="bi bi-arrow-repeat"></i>
                        <input type="number" id="edit_restart_retries" min="0" value="0">
                    </div>
                </div>
            </div>

            <div class="input-field" style="margin-top: 16px;">
                <label>Assigned Users</label>
                <div class="user-picker">
                    <div class="input-wrapper">
                        <i class="bi bi-search"></i>
                        <input type="text" id="edit_user_search" placeholder="Search user..." oninput="renderEditUserPicker(this.value)">
                    </div>
                    <div id="edit_users_list" class="users-list"></div>
                    <div id="edit_users_selected" class="selected-users"></div>
                </div>
            </div>

            <div class="input-field" style="margin-top: 16px;">
                <label>Role Permissions</label>
                <div id="edit_role_permissions_grid" style="border:1px solid var(--border); border-radius: 12px; overflow:auto; background:#07070b;"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeContainerSettingsModal()" class="btn-secondary">Cancel</button>
            <button onclick="saveContainerSettingsModal()" class="btn-primary" id="saveSettingsBtn">Save Changes</button>
        </div>
    </div>
</div>
{% endif %}

{% if session.get('is_staff') %}
<div id="deployProgressModal" class="modal-overlay">
    <div class="modal-content" style="width: 760px;">
        <div class="modal-header">
            <div>
                <h3 style="margin: 0; font-weight: 700; color: white;">Deployment Progress</h3>
                <p id="deployStage" style="margin: 4px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">Preparing deployment...</p>
            </div>
            <button onclick="closeDeployProgressModal()" class="close-modal-btn"><i class="bi bi-x-lg"></i></button>
        </div>
        <div style="padding: 24px 28px;">
            <div style="height: 12px; background: #09090c; border: 1px solid var(--border); border-radius: 999px; overflow: hidden;">
                <div id="deployProgressFill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #4f7cff, #67e8f9); transition: width 0.35s ease;"></div>
            </div>
            <div id="deployProgressText" style="margin-top: 10px; color: var(--text-muted); font-size: 0.82rem;">0%</div>
            <details style="margin-top: 16px; border: 1px solid var(--border); border-radius: 12px; background: #09090d;">
                <summary style="padding: 12px 14px; cursor: pointer; color: #d3d3db; font-weight: 600;">Deployment Log</summary>
                <pre id="deployLogOutput" style="margin:0; max-height: 320px; overflow:auto; padding: 12px 14px; color: #bfc1d1; font-size: 0.78rem; line-height: 1.45;"></pre>
            </details>
        </div>
        <div class="modal-footer">
            <button id="deployProgressCloseBtn" onclick="closeDeployProgressModal()" class="btn-secondary">Close</button>
        </div>
    </div>
</div>
{% endif %}

{% if session.get('is_staff') %}
<div id="deployErrorModal" class="modal-overlay">
    <div class="modal-content" style="width: 760px;">
        <div class="modal-header">
            <div>
                <h3 style="margin: 0; font-weight: 700; color: white;">Deployment Error</h3>
                <p id="deployErrorSummary" style="margin: 4px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">Unknown error</p>
            </div>
            <button onclick="closeDeployErrorModal()" class="close-modal-btn"><i class="bi bi-x-lg"></i></button>
        </div>
        <div style="padding: 20px 24px;">
            <div id="deployErrorHint" style="font-size: 0.84rem; color: #d3d6e6; margin-bottom: 12px;"></div>
            <details style="border: 1px solid var(--border); border-radius: 12px; background: #09090d;">
                <summary style="padding: 12px 14px; cursor: pointer; color: #d3d3db; font-weight: 600;">
                    <i class="bi bi-chevron-down" style="margin-right:6px;"></i> Show Raw Error Log
                </summary>
                <pre id="deployErrorRaw" style="margin:0; max-height: 280px; overflow:auto; padding: 12px 14px; color: #bfc1d1; font-size: 0.78rem; line-height: 1.45;"></pre>
            </details>
        </div>
        <div class="modal-footer">
            <button onclick="closeDeployErrorModal()" class="btn-secondary">Close</button>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
