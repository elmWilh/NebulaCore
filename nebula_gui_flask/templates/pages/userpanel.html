{% extends "layout.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/userpanel.css') }}">
{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="{{ url_for('static', filename='js/pages/userpanel.js') }}"></script>
{% endblock %}
{% block page_content %}
<div class="container-fluid" style="padding: 32px; max-width: 1400px; margin: 0 auto;">
    <div class="profile-header-card">
        <div style="display: flex; align-items: center; gap: 24px;">
            <div class="avatar-circle"><span id="avatar-initial">{{ (username or 'U')[0]|upper }}</span></div>
            <div>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <h1 style="margin: 0; font-weight: 800; color: white; font-size: 1.8rem;">{{ username }}</h1>
                    <span id="panel-role-badge" class="badge {{ 'badge-admin' if is_staff else 'badge-user' }}">{{ 'ADMIN' if is_staff else 'USER' }}</span>
                </div>
                <div style="display: flex; gap: 20px; color: var(--text-muted); font-size: 0.88rem;">
                    <span><i class="bi bi-hdd-network" style="margin-right: 6px;"></i> Sector: <span id="panel-db">{{ session.get('db_name') }}</span></span>
                    <span><i class="bi bi-box" style="margin-right: 6px;"></i> Containers: <span id="panel-containers">0</span></span>
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn-secondary" id="btn-2fa"><i class="bi bi-shield-lock"></i> 2FA</button>
            <a class="add-user-btn" href="{{ url_for('view_user_page', username=username) }}?db_name={{ session.get('db_name') }}"><i class="bi bi-gear-fill"></i> Account Settings</a>
        </div>
    </div>

    <div class="stats-row">
        <div class="stat-box"><span>Running</span><strong id="stat-running">0</strong></div>
        <div class="stat-box"><span>Total</span><strong id="stat-total">0</strong></div>
        <div class="stat-box"><span>CPU</span><strong id="stat-cpu">0%</strong></div>
        <div class="stat-box"><span>RAM</span><strong id="stat-ram">0%</strong></div>
        <div class="stat-box"><span>Databases</span><strong id="stat-db">0</strong></div>
    </div>

    <div class="dashboard-grid">
        <div class="dashboard-col">
            <h3 class="section-title">Active Resources</h3>
            <div class="table-card">
                <div class="card-header">Deployed Containers</div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr class="table-header-row">
                            <th style="padding: 14px 20px;">Name</th>
                            <th style="padding: 14px 20px;">Image</th>
                            <th style="padding: 14px 20px;">Access</th>
                            <th style="padding: 14px 20px;">State</th>
                            <th style="padding: 14px 20px; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="containers-tbody">
                        <tr><td colspan="5" style="padding: 20px; color: var(--text-muted);">Loading containers...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-card" style="margin-top: 20px;">
                <div class="card-header">Database Clusters</div>
                <div id="db-list" style="padding: 18px; display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 12px;">
                    <div class="db-node">Loading databases...</div>
                </div>
            </div>
        </div>

        <div class="dashboard-col" style="flex: 0 0 380px;">
            <h3 class="section-title">Security Audit</h3>
            <div class="table-card" style="padding: 0;">
                <div class="card-header">Recent Activity</div>
                <div class="log-list" id="audit-list">
                    <div class="log-item"><div style="color: var(--text-muted);">Loading activity...</div></div>
                </div>
                {% if is_staff %}
                <a href="/logs" class="view-all-logs">View Full Audit Trail <i class="bi bi-arrow-right"></i></a>
                {% else %}
                <a href="#" class="view-all-logs" onclick="return false;">Audit trail requires staff access</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="logs-modal" class="modal-overlay" onclick="if(event.target===this){closeLogsModal();}">
    <div class="modal-content" style="max-width: 980px; width: 92%;">
        <div class="modal-header">
            <h3 style="margin: 0; color: white; font-size: 1rem;">Container Logs: <span id="logs-title"></span></h3>
            <button class="btn-secondary" onclick="closeLogsModal()"><i class="bi bi-x-lg"></i></button>
        </div>
        <pre id="logs-content" style="margin: 0; padding: 16px; max-height: 70vh; overflow: auto; font-size: 0.8rem; color: #d6d6d6; background: #050507; border-top: 1px solid var(--border);"></pre>
    </div>
</div>

<div id="twofa-modal" class="modal-overlay" onclick="if(event.target===this){close2FAModal();}">
    <div class="modal-content" style="max-width: 560px; width: 92%;">
        <div class="modal-header">
            <h3 style="margin: 0; color: white; font-size: 1rem;">Two-Factor Authentication</h3>
            <button class="btn-secondary" onclick="close2FAModal()"><i class="bi bi-x-lg"></i></button>
        </div>
        <div style="padding: 16px;">
            <div id="twofa-status" style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 14px;">Loading status...</div>
            <div id="twofa-setup-box" style="display:none;">
                <p style="margin: 0 0 12px; color: #d1d1d1; font-size: 0.86rem;">
                    1) Scan QR in Google Authenticator, 2) enter 6-digit code to confirm.
                </p>
                <div id="twofa-qr" style="width:220px;height:220px;background:white;padding:8px;border-radius:10px;margin-bottom:10px;"></div>
                <code id="twofa-secret" style="display:block; margin-bottom:12px; color:#4ade80; font-size:0.78rem;"></code>
                <div style="display:flex; gap:8px;">
                    <input id="twofa-code" type="text" maxlength="6" placeholder="123456" style="flex:1; background:#050507;border:1px solid var(--border);color:white;border-radius:10px;padding:10px 12px;">
                    <button class="add-user-btn" onclick="confirm2FA()">Confirm</button>
                </div>
            </div>
            <div id="twofa-disable-box" style="display:none;">
                <p style="margin: 0 0 10px; color: #d1d1d1; font-size: 0.86rem;">2FA enabled. Enter current code to disable.</p>
                <div style="display:flex; gap:8px;">
                    <input id="twofa-disable-code" type="text" maxlength="6" placeholder="123456" style="flex:1; background:#050507;border:1px solid var(--border);color:white;border-radius:10px;padding:10px 12px;">
                    <button class="btn-secondary" onclick="disable2FA()">Disable</button>
                </div>
            </div>
            <div id="twofa-error" style="display:none; margin-top:10px; color:#ff6b6b; font-size:0.82rem;"></div>
        </div>
    </div>
</div>
{% endblock %}
