{% extends "layout.html" %}
{% block page_content %}
<div class="container-fluid" style="padding: 24px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; gap: 12px; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 12px;">
            <a href="{{ '/users' if session.get('is_staff') else '/userpanel' }}" class="back-btn"><i class="bi bi-arrow-left"></i></a>
            <div>
                <h2 style="font-weight: 700; margin: 0; color: white;">User Profile: <span id="profile-username">{{ user.username }}</span></h2>
                <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">UUID: <span id="profile-uuid">-</span> â€¢ DB: <span id="profile-db">{{ user.db_name }}</span></p>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn-secondary" onclick="loadProfileData()"><i class="bi bi-arrow-clockwise"></i> Sync</button>
            <a class="btn-primary" href="/userpanel"><i class="bi bi-person-circle"></i> Open User Panel</a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><i class="bi bi-box"></i><div><span class="label">Containers</span><div class="value" id="stat-containers">0</div></div></div>
        <div class="stat-card"><i class="bi bi-play-circle"></i><div><span class="label">Running</span><div class="value" id="stat-running">0</div></div></div>
        <div class="stat-card"><i class="bi bi-cpu"></i><div><span class="label">CPU</span><div class="value" id="stat-cpu">0%</div></div></div>
        <div class="stat-card"><i class="bi bi-memory"></i><div><span class="label">RAM</span><div class="value" id="stat-ram">0%</div></div></div>
    </div>

    <div class="main-profile-grid">
        <div class="content-card">
            <div class="card-header"><i class="bi bi-person-vcard"></i> Identity & Core Data</div>
            <div class="card-body">
                <div class="data-row">
                    <div class="avatar-large"><i class="bi bi-person-fill"></i></div>
                    <div style="flex: 1;">
                        <div class="info-group">
                            <label>Email Address</label>
                            <span id="profile-email">-</span>
                        </div>
                        <div class="info-group">
                            <label>Root Directory</label>
                            <code class="code-block" id="profile-root">-</code>
                        </div>
                        <div class="info-group" style="margin-bottom:0;">
                            <label>Role</label>
                            <span id="profile-role">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card">
            <div class="card-header"><span><i class="bi bi-box-seam"></i> Virtual Instances</span><span class="badge-count" id="instance-count">0 visible</span></div>
            <div class="card-table-wrapper">
                <table class="sub-table">
                    <thead><tr><th>Name / ID</th><th>Image</th><th>Status</th><th style="text-align:right;">Action</th></tr></thead>
                    <tbody id="instances-body"><tr><td colspan="4" style="padding:14px; color: var(--text-muted);">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --bg-dark: #050507;
        --card-bg: #0d0d12;
        --accent: #5865f2;
        --border: rgba(255, 255, 255, 0.08);
        --text-muted: #888891;
    }
    .back-btn { width: 40px; height: 40px; border-radius: 12px; background: var(--card-bg); border: 1px solid var(--border); color: white; display: flex; align-items: center; justify-content: center; text-decoration: none; }
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 18px; }
    .stat-card { background: var(--card-bg); border: 1px solid var(--border); padding: 16px; border-radius: 14px; display: flex; align-items: center; gap: 12px; }
    .stat-card i { font-size: 1.2rem; color: var(--accent); }
    .stat-card .label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); }
    .stat-card .value { font-size: 1.05rem; font-weight: 700; color: white; }

    .main-profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .content-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
    .card-header { padding: 14px 18px; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border); font-weight: 700; color: white; display: flex; justify-content: space-between; align-items: center; }
    .card-body { padding: 18px; }
    .data-row { display: flex; gap: 16px; align-items: flex-start; }
    .avatar-large { width: 68px; height: 68px; background: #1a1a1e; border-radius: 14px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); font-size: 1.7rem; color: var(--text-muted); }
    .info-group { margin-bottom: 16px; }
    .info-group label { display: block; font-size: 0.65rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 6px; }
    .info-group span { color: white; font-size: 0.92rem; }
    .code-block { background: #050507; padding: 9px 12px; border-radius: 8px; border: 1px solid var(--border); color: #4ade80; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; display: block; }

    .card-table-wrapper { padding: 0 12px 12px 12px; }
    .sub-table { width: 100%; border-collapse: collapse; }
    .sub-table th { padding: 12px; font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; text-align: left; border-bottom: 1px solid var(--border); }
    .sub-table td { padding: 12px; font-size: 0.84rem; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.04); }
    .badge-count { font-size: 0.68rem; background: var(--accent); color: white; padding: 2px 7px; border-radius: 6px; }
    .status-pill { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
    .status-pill.online { background: rgba(74, 222, 128, 0.12); color: #4ade80; }
    .status-pill.offline { background: rgba(248, 113, 113, 0.12); color: #f87171; }

    .btn-primary, .btn-secondary { border-radius: 10px; padding: 10px 14px; text-decoration: none; border: 1px solid var(--border); color: white; background: #11131a; cursor: pointer; }
    .btn-primary { background: var(--accent); border-color: transparent; }

    .mini-btn { border: 1px solid var(--border); background: #0f1016; color: #ddd; border-radius: 8px; font-size: 0.72rem; padding: 5px 8px; cursor: pointer; }

    @media (max-width: 1100px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
        .main-profile-grid { grid-template-columns: 1fr; }
    }
</style>

<script>
const profileUsername = {{ user.username|tojson }};
const profileDbName = {{ user.db_name|tojson }};

function statusPill(status) {
    return String(status || '').toLowerCase() === 'running'
        ? '<span class="status-pill online">Online</span>'
        : '<span class="status-pill offline">Stopped</span>';
}

async function callContainerAction(action, id) {
    const res = await fetch(`/api/containers/${action}/${id}`, { method: 'POST' });
    const payload = await res.json();
    if (!res.ok) {
        alert(payload.detail || `Action ${action} failed`);
        return;
    }
    await loadProfileData();
}

async function loadProfileData() {
    const detailRes = await fetch(`/api/users/detail/${encodeURIComponent(profileUsername)}?db_name=${encodeURIComponent(profileDbName)}`);
    const detail = await detailRes.json();
    if (!detailRes.ok) {
        alert(detail.detail || 'Failed to load user details');
        return;
    }

    document.getElementById('profile-uuid').textContent = detail.id;
    document.getElementById('profile-db').textContent = detail.db_name || profileDbName;
    document.getElementById('profile-email').textContent = detail.email || '-';
    document.getElementById('profile-root').textContent = `/home/cloud_sys/users/${detail.username}`;
    document.getElementById('profile-role').textContent = detail.is_staff ? 'Administrator' : 'User';

    const metricsRes = await fetch('/api/metrics');
    const metrics = await metricsRes.json();
    if (metricsRes.ok) {
        document.getElementById('stat-cpu').textContent = metrics.cpu || '0%';
        document.getElementById('stat-ram').textContent = metrics.ram || '0%';
    }

    const containersRes = await fetch('/api/containers/list');
    const containers = await containersRes.json();
    const tbody = document.getElementById('instances-body');
    if (!containersRes.ok || !Array.isArray(containers)) {
        tbody.innerHTML = '<tr><td colspan="4" style="padding:14px;color:#ff6b6b;">Failed to load containers</td></tr>';
        return;
    }

    const running = containers.filter(c => String(c.status || '').toLowerCase() === 'running').length;
    document.getElementById('stat-containers').textContent = containers.length;
    document.getElementById('stat-running').textContent = running;
    document.getElementById('instance-count').textContent = `${containers.length} visible`;

    if (containers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="padding:14px;color:var(--text-muted);">No instances available</td></tr>';
        return;
    }

    tbody.innerHTML = '';
    containers.forEach(cont => {
        const isRunning = String(cont.status || '').toLowerCase() === 'running';
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${cont.name}</strong><div style="font-size:0.72rem; color: var(--text-muted);">${cont.id}</div></td>
            <td>${cont.image || '-'}</td>
            <td>${statusPill(cont.status)}</td>
            <td style="text-align:right;"><button class="mini-btn" onclick="callContainerAction('${isRunning ? 'stop' : 'start'}','${cont.id}')">${isRunning ? 'Stop' : 'Start'}</button></td>
        `;
        tbody.appendChild(row);
    });
}

document.addEventListener('DOMContentLoaded', loadProfileData);
</script>
{% endblock %}
