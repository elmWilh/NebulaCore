{% extends "layout.html" %}
{#
  nebula_gui_flask/templates/pages/container_workspace.html
  Copyright (c) 2026 Monolink Systems
  Licensed under AGPLv3 (Nebula Open Source Edition, non-corporate)
#}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/container_workspace.css') }}">
{% endblock %}
{% block extra_js %}
<script>
window.NebulaWorkspace = {
    containerId: {{ container_id|tojson }}
};
</script>
<script src="{{ url_for('static', filename='js/pages/container_workspace.js') }}"></script>
{% endblock %}
{% block page_content %}
<div class="container-fluid ws-shell">
    <header class="workspace-header card-shell">
        <div class="header-left">
            <div class="workspace-title-row">
                <a href="/containers" class="back-link" title="Back to containers">
                    <i class="bi bi-chevron-left"></i>
                </a>
                <h2>Container Panel</h2>
                <span id="ws-status-pill" class="status-pill">loading</span>
            </div>
            <div class="workspace-meta">
                <span class="meta-item"><i class="bi bi-box-seam"></i> <span id="ws-name">{{ container_id }}</span></span>
                <span class="meta-dot">/</span>
                <span class="meta-item"><i class="bi bi-hash"></i> <span id="ws-id">{{ container_id }}</span></span>
                <span class="meta-dot">/</span>
                <span class="meta-item"><i class="bi bi-layers"></i> <span id="ws-image">loading image...</span></span>
            </div>
            <div id="workspace-context" class="workspace-context">Loading container context...</div>
        </div>
        <div class="workspace-actions">
            <button id="ws-start-btn" class="btn-ghost" onclick="containerAction('start')"><i class="bi bi-play-fill"></i> Start</button>
            <button id="ws-stop-btn" class="btn-ghost" onclick="containerAction('stop')"><i class="bi bi-stop-fill"></i> Stop</button>
            <button id="ws-restart-btn" class="btn-ghost" onclick="containerAction('restart')"><i class="bi bi-arrow-repeat"></i> Restart</button>
            <button class="btn-primary" onclick="refreshActiveTab()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
        </div>
    </header>

    <div class="ws-grid">
        <aside class="ws-nav card-shell">
            <nav>
                <button class="tab-btn active" data-tab="terminal" onclick="switchTab('terminal')">
                    <i class="bi bi-terminal"></i> <span>Terminal & Logs</span>
                </button>
                <button id="tab-btn-files" class="tab-btn" data-tab="files" onclick="switchTab('files')">
                    <i class="bi bi-folder2-open"></i> <span>File Explorer</span>
                </button>
                <button class="tab-btn" data-tab="toolbox" onclick="switchTab('toolbox')">
                    <i class="bi bi-tools"></i> <span>Toolbox</span>
                </button>
                <button id="tab-btn-settings" class="tab-btn" data-tab="settings" onclick="switchTab('settings')">
                    <i class="bi bi-sliders"></i> <span>Settings</span>
                </button>
            </nav>
        </aside>

        <section class="ws-content card-shell">
            <div id="tab-terminal" class="tab-pane active">
                <div class="pane-header">
                    <h3 class="pane-title">Live Console</h3>
                    <p class="pane-subtitle">Unified terminal for app console or restricted workspace shell, with live logs in one stream.</p>
                </div>

                <div class="terminal-grid">
                    <div class="terminal-panel unified-console">
                        <div class="panel-head">
                            <span class="head-label"><i class="bi bi-terminal-fill"></i> Live Terminal + Container Logs</span>
                            <span id="logs-sync-state" class="head-note">not synced</span>
                            <div class="window-dots" aria-hidden="true">
                                <span class="dot red"></span>
                                <span class="dot yellow"></span>
                                <span class="dot green"></span>
                            </div>
                        </div>

                        <div class="console-tools">
                            <div class="log-controls">
                                <label for="logs-tail">Tail</label>
                                <input id="logs-tail" type="number" value="300" min="50" max="2000" title="Lines to fetch">
                                <button class="chip-btn" onclick="loadLogs(true)">Load</button>
                                <button id="logs-auto-btn" class="chip-btn active" onclick="toggleAutoLogs()">Auto: ON</button>
                            </div>
                            <div id="quick-row" class="quick-row">
                                <button class="chip-btn" onclick="runCommandText('help')">help</button>
                                <button class="chip-btn" onclick="runCommandText('list')">list</button>
                                <button class="chip-btn" onclick="runCommandText('status')">status</button>
                                <button class="chip-btn" onclick="runCommandText('stop')">stop</button>
                            </div>
                            <div class="inline-actions">
                                <button class="chip-btn" onclick="copyText('live-console-output')"><i class="bi bi-clipboard"></i> Copy</button>
                                <button class="chip-btn" onclick="downloadLogs()"><i class="bi bi-download"></i> Download</button>
                                <button class="chip-btn" onclick="clearOutput('live-console-output', 'Console view cleared.')"><i class="bi bi-eraser"></i> Clear</button>
                            </div>
                        </div>

                        <div class="console-input-row">
                            <select id="cmd-mode" class="cmd-mode-select" title="Console mode" onchange="onConsoleModeChange()">
                                <option value="console">App Console</option>
                                <option value="shell">Workspace Shell</option>
                            </select>
                            <div class="prompt-wrapper">
                                <span class="prompt">&gt;</span>
                                <input id="cmd-input" type="text" placeholder="Type command..." onkeydown="if(event.key==='Enter'){runCommand();}">
                            </div>
                            <button id="cmd-run-btn" class="btn-run" onclick="runCommand()">Send</button>
                        </div>
                        <div id="cmd-status" class="action-status">Console ready.</div>
                        <pre id="live-console-output" class="terminal-output logs-view">Loading stream...</pre>
                    </div>
                </div>
            </div>

            <div id="tab-files" class="tab-pane">
                <div class="pane-header">
                    <h3 class="pane-title">File Explorer</h3>
                    <p class="pane-subtitle">Explorer is restricted to workspace paths for safety.</p>
                </div>

                <div id="workspace-roots" class="roots-row"></div>

                <div class="files-toolbar">
                    <div class="path-input-group">
                        <i class="bi bi-folder-symlink"></i>
                        <input id="files-path" type="text" value="/data" onkeydown="if(event.key==='Enter'){loadFiles();}">
                    </div>
                    <div class="button-group">
                        <button class="btn-ghost" onclick="goParentDir()"><i class="bi bi-arrow-up"></i> Up</button>
                        <button class="btn-primary" onclick="loadFiles()"><i class="bi bi-arrow-repeat"></i> Reload</button>
                    </div>
                </div>

                <div class="files-layout">
                    <div id="files-list" class="files-list"></div>
                </div>
            </div>

            <div id="tab-toolbox" class="tab-pane">
                <div class="pane-header">
                    <h3 class="pane-title">Quick Operations</h3>
                    <p class="pane-subtitle">Apply common scenarios, then verify them with one click.</p>
                </div>

                <div id="tool-grid" class="tool-grid">
                    <div class="tool-card" data-profiles="minecraft">
                        <div class="tool-icon"><i class="bi bi-controller"></i></div>
                        <div class="tool-info">
                            <h4>Minecraft Java</h4>
                            <p>Applies ports and startup command for a Java server baseline.</p>
                        </div>
                        <div class="tool-actions">
                            <button class="btn-tool" onclick="applyScenario('minecraft')">Apply</button>
                            <button class="btn-tool outline" onclick="fixMinecraftBootLoop()">Fix Loop</button>
                            <button class="btn-tool outline" onclick="switchTab('files')">Open Files</button>
                        </div>
                    </div>

                    <div class="tool-card" data-profiles="steam">
                        <div class="tool-icon"><i class="bi bi-cpu"></i></div>
                        <div class="tool-info">
                            <h4>SteamCMD Dedicated</h4>
                            <p>Preset for typical dedicated game server startup flow.</p>
                        </div>
                        <div class="tool-actions">
                            <button class="btn-tool" onclick="applyScenario('steamcmd')">Apply</button>
                            <button class="btn-tool outline" onclick="switchTab('files')">Open Files</button>
                        </div>
                    </div>

                    <div class="tool-card" data-profiles="minecraft,steam,web,database,generic">
                        <div class="tool-icon"><i class="bi bi-activity"></i></div>
                        <div class="tool-info">
                            <h4>Diagnostics</h4>
                            <p>Fast visibility for process, ports, memory and storage pressure.</p>
                        </div>
                        <div class="tool-actions">
                            <button class="btn-tool outline" onclick="loadLogs(true)">Refresh Logs</button>
                            <button class="btn-tool outline" onclick="refreshActiveTab()">Refresh Console</button>
                        </div>
                    </div>

                    <div class="tool-card" data-profiles="minecraft">
                        <div class="tool-icon"><i class="bi bi-lightning-charge"></i></div>
                        <div class="tool-info">
                            <h4>Minecraft Ops</h4>
                            <p>Common in-game operations with one click from panel.</p>
                        </div>
                        <div class="tool-actions">
                            <button class="btn-tool outline" onclick="runCommandText('list')">Players</button>
                            <button class="btn-tool outline" onclick="runCommandText('save-all')">Save All</button>
                            <button class="btn-tool outline" onclick="runCommandText('time set day')">Set Day</button>
                        </div>
                    </div>

                    <div class="tool-card" data-profiles="web,generic">
                        <div class="tool-icon"><i class="bi bi-window-stack"></i></div>
                        <div class="tool-info">
                            <h4>Web Service Ops</h4>
                            <p>Focus on logs, config files and restart flow for web apps and bots.</p>
                        </div>
                        <div class="tool-actions">
                            <button class="btn-tool outline" onclick="switchTab('files')">Open Config Files</button>
                            <button class="btn-tool outline" onclick="switchTab('settings')">Open Port Settings</button>
                            <button class="btn-tool outline" onclick="containerAction('restart')">Restart Service</button>
                        </div>
                    </div>

                    <div class="tool-card" data-profiles="database">
                        <div class="tool-icon"><i class="bi bi-database"></i></div>
                        <div class="tool-info">
                            <h4>Database Ops</h4>
                            <p>Safe defaults for DB containers: logs, backup path checks, controlled restart.</p>
                        </div>
                        <div class="tool-actions">
                            <button class="btn-tool outline" onclick="loadLogs(true)">Inspect DB Logs</button>
                            <button class="btn-tool outline" onclick="switchTab('files')">Open Data Files</button>
                            <button class="btn-tool outline" onclick="containerAction('restart')">Restart DB</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-settings" class="tab-pane">
                <div class="pane-header">
                    <h3 class="pane-title">Panel Settings</h3>
                    <p class="pane-subtitle">Save startup preferences for this container.</p>
                </div>

                <div class="settings-card">
                    <div class="form-group">
                        <label>Port Forwarding Rules</label>
                        <input id="set-ports" type="text" placeholder="e.g. 25565:25565, 19132:19132/udp">
                        <small>Selected forwarding rules. Toggle available ports below to build this value.</small>
                    </div>

                    <div class="form-group">
                        <label>Available Port Allocation</label>
                        <div id="ports-selection-meta" class="ports-selection-meta">Loading available container ports...</div>
                        <div class="ports-toolbar">
                            <input id="ports-search" type="text" placeholder="Filter rules (e.g. 25565, udp, 127.0.0.1)" oninput="filterPortsSelection()">
                            <button class="chip-btn" type="button" onclick="setAllPortsSelection(true)">Select All</button>
                            <button class="chip-btn" type="button" onclick="setAllPortsSelection(false)">Clear</button>
                        </div>
                        <div id="ports-selection" class="ports-selection"></div>
                        <small>Only pre-allocated container ports can be enabled here.</small>
                    </div>

                    <div class="form-group">
                        <label>Startup Command</label>
                        <input id="set-command" type="text" placeholder="e.g. ./start.sh or python app.py">
                        <small id="startup-command-hint">Overrides default startup command.</small>
                    </div>

                    <div class="form-group restart-card">
                        <label>Auto-Restart Policy</label>
                        <div class="restart-row">
                            <select id="restart-policy-select">
                                <option value="always">always</option>
                                <option value="unless-stopped">unless-stopped</option>
                                <option value="on-failure">on-failure</option>
                                <option value="no">no (disabled)</option>
                            </select>
                            <input id="restart-retries" type="number" value="0" min="0" max="50" placeholder="Retries" title="Used for on-failure only">
                            <button class="btn-ghost" onclick="saveRestartPolicy()"><i class="bi bi-arrow-repeat"></i> Apply Policy</button>
                        </div>
                        <small id="restart-policy-hint" class="policy-hint">Tip: if you are testing mods/builds, disabling auto-restart can make debugging easier.</small>
                    </div>

                    <div class="settings-footer">
                        <button class="btn-save" onclick="saveSettings()">
                            <i class="bi bi-check-circle"></i> Save Settings
                        </button>
                        <span id="settings-meta" class="settings-meta"></span>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<div id="toast-zone" class="toast-zone" aria-live="polite" aria-atomic="true"></div>

<div id="file-preview-modal" class="file-modal-overlay" onclick="if(event.target===this){closeFilePreviewModal();}">
    <div class="file-modal-content">
        <div class="preview-header">
            <span id="preview-path-title">File Preview</span>
            <div class="inline-actions">
                <button class="chip-btn" onclick="copyText('file-preview')"><i class="bi bi-clipboard"></i> Copy</button>
                <button class="chip-btn" onclick="closeFilePreviewModal()"><i class="bi bi-x-lg"></i> Close</button>
            </div>
        </div>
        <pre id="file-preview" class="terminal-output preview-box">Select a file to view its contents.</pre>
    </div>
</div>
{% endblock %}
