{% extends "layout.html" %}

{% block page_content %}
<style>
  .grid {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }
  .grid .card {
    min-width: 0;
    min-height: 132px;
    height: auto;
  }
  .grid .card-value {
    font-size: clamp(1.35rem, 2.3vw, 2.2rem);
    line-height: 1.15;
    word-break: break-word;
  }
</style>

<div class="grid">
  <div class="card">
    <div class="card-title">CPU Usage</div>
    <div class="card-value" id="cpu">—</div>
  </div>
  <div class="card">
    <div class="card-title">RAM Usage</div>
    <div class="card-value" id="ram">—</div>
  </div>
  <div class="card">
    <div class="card-title">Disk Storage</div>
    <div class="card-value" id="disk">—</div>
  </div>
  <div class="card">
    <div class="card-title">Network Throughput</div>
    <div class="card-value" id="network">—</div>
  </div>
  <div class="card">
    <div class="card-title">Active Containers</div>
    <div class="card-value" id="containers">—</div>
  </div>
  <div class="card">
    <div class="card-title">Servers Online</div>
    <div class="card-value" id="servers">—</div>
  </div>
  <div class="card">
    <div class="card-title">Critical Alerts</div>
    <div class="card-value" id="alerts">—</div>
  </div>
  <div class="card">
    <div class="card-title">Tasks in Queue</div>
    <div class="card-value" id="tasks">—</div>
  </div>
</div>

{% if session.get('is_staff') %}
<div class="admin-observatory">
  <div class="observatory-header">
    <div>
      <h2>Admin Observatory</h2>
      <p>Live server telemetry and container memory map</p>
    </div>
    <div class="observatory-status">
      <span class="status-dot"></span>
      <span id="admin-metrics-updated">syncing...</span>
    </div>
  </div>

  <div class="observatory-grid">
    <section class="obs-card obs-card-wide">
      <div class="obs-card-head">
        <h3>RAM Usage Timeline</h3>
        <span id="ram-quick">—</span>
      </div>
      <div class="chart-box chart-box-line">
        <canvas id="ramTimelineChart"></canvas>
      </div>
    </section>

    <section class="obs-card obs-card-wide">
      <div class="obs-card-head">
        <h3>Network Throughput</h3>
        <span id="network-quick">—</span>
      </div>
      <div class="chart-box chart-box-line">
        <canvas id="networkTimelineChart"></canvas>
      </div>
    </section>

    <section class="obs-card obs-card-third">
      <div class="obs-card-head">
        <h3>Container RAM Distribution</h3>
        <span id="containers-mem-total">—</span>
      </div>
      <div class="chart-box chart-box-donut">
        <canvas id="containerMemoryChart"></canvas>
      </div>
    </section>

    <section class="obs-card obs-card-third">
      <div class="obs-card-head">
        <h3>Container Disk Distribution</h3>
        <span id="containers-disk-total">—</span>
      </div>
      <div class="chart-box chart-box-donut">
        <canvas id="containerDiskChart"></canvas>
      </div>
    </section>

    <section class="obs-card obs-card-third disks-card">
      <div class="obs-card-head">
        <h3>Available Disks</h3>
        <span id="disk-count">0</span>
      </div>
      <div class="disks-list" id="disks-list">
        <div class="disk-row disk-empty">No disk data</div>
      </div>
    </section>
  </div>
</div>

<style>
  .admin-observatory {
    margin-top: 24px;
    padding: 24px;
    width: 100%;
    max-width: 100%;
    overflow: hidden;
    border-radius: 18px;
    border: 1px solid var(--border);
    background:
      radial-gradient(980px 280px at 0% -10%, rgba(88, 101, 255, 0.16), transparent 55%),
      radial-gradient(860px 220px at 100% 0%, rgba(88, 101, 255, 0.08), transparent 55%),
      linear-gradient(165deg, rgba(18, 19, 26, 0.96), rgba(14, 15, 20, 0.92));
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04), 0 18px 34px rgba(0, 0, 0, 0.28);
  }
  .observatory-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .observatory-header h2 {
    font-size: 1.2rem;
    color: #f0f2ff;
    letter-spacing: 0.01em;
  }
  .observatory-header p {
    margin-top: 4px;
    font-size: 0.88rem;
    color: var(--text-muted);
  }
  .observatory-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    color: #c8cde5;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 6px 12px;
  }
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #6c7bff;
    box-shadow: 0 0 0 6px rgba(88, 101, 255, 0.2);
  }
  .observatory-grid {
    display: grid;
    grid-template-columns: repeat(12, minmax(0, 1fr));
    gap: 14px;
    width: 100%;
  }
  .obs-card {
    grid-column: span 6;
    min-width: 0;
    background: linear-gradient(165deg, rgba(15, 17, 24, 0.9), rgba(12, 13, 19, 0.86));
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
    min-height: 240px;
    overflow: hidden;
  }
  .obs-card-third {
    grid-column: span 4;
  }
  .obs-card-wide {
    grid-column: span 12;
    min-height: 250px;
  }
  .obs-card-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .obs-card-head h3 {
    font-size: 0.95rem;
    color: #e6e9f8;
    letter-spacing: 0.01em;
  }
  .obs-card-head span {
    font-size: 0.82rem;
    color: #b2bbeb;
    font-weight: 600;
  }
  .disks-card {
    min-height: 240px;
  }
  .disks-list {
    display: grid;
    gap: 8px;
    max-height: 268px;
    overflow: auto;
    padding-right: 4px;
  }
  .disk-row {
    border: 1px solid var(--border);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.02);
    padding: 10px;
  }
  .disk-main {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    font-size: 0.82rem;
    color: #dce0ef;
    margin-bottom: 8px;
    gap: 8px;
  }
  .disk-main .mount {
    color: #c7cfff;
    font-weight: 700;
  }
  .disk-sub {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    font-size: 0.74rem;
    color: #98a0bc;
    margin-bottom: 6px;
  }
  .disk-bar {
    height: 8px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.07);
    overflow: hidden;
  }
  .disk-fill {
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(90deg, #5865ff, #8793ff);
  }
  .disk-empty {
    color: #98a0bc;
    text-align: center;
  }
  .chart-box {
    position: relative;
    width: 100%;
  }
  .chart-box-line {
    height: 170px;
  }
  .chart-box-donut {
    height: 230px;
  }
  .obs-card canvas {
    width: 100% !important;
    max-width: 100%;
    height: 100% !important;
  }
  @media (max-width: 1024px) {
    .obs-card,
    .obs-card-third,
    .obs-card-wide {
      grid-column: span 12;
      min-height: 230px;
    }
  }
  @media (max-width: 640px) {
    .admin-observatory {
      padding: 14px;
    }
    .observatory-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }
    .chart-box-line {
      height: 150px;
    }
    .chart-box-donut {
      height: 210px;
    }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  let ramChart = null;
  let networkChart = null;
  let containersChart = null;
  let containerDiskChart = null;

  function formatTimePoint(ts) {
    const d = new Date(ts * 1000);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function safeNumber(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function makeOrUpdateChart(target, config, existing) {
    if (!existing) {
      return new Chart(target, config);
    }
    existing.data = config.data;
    existing.options = config.options;
    existing.update('none');
    return existing;
  }

  function renderDisks(disks) {
    const wrap = document.getElementById('disks-list');
    const countEl = document.getElementById('disk-count');
    if (!wrap || !countEl) return;
    if (!Array.isArray(disks) || disks.length === 0) {
      wrap.innerHTML = '<div class="disk-row disk-empty">No disk data</div>';
      countEl.textContent = '0';
      return;
    }
    countEl.textContent = String(disks.length);
    wrap.innerHTML = disks.map((d) => {
      const pct = Math.max(0, Math.min(100, safeNumber(d.percent)));
      return `
        <div class="disk-row">
          <div class="disk-main">
            <span class="mount">${d.mountpoint}</span>
            <span>${pct.toFixed(1)}%</span>
          </div>
          <div class="disk-sub">
            <span>${d.device} • ${d.fstype}</span>
            <span>${safeNumber(d.used_gb).toFixed(1)} / ${safeNumber(d.total_gb).toFixed(1)} GB</span>
          </div>
          <div class="disk-bar"><div class="disk-fill" style="width:${pct}%"></div></div>
        </div>
      `;
    }).join('');
  }

  async function updateAdminDashboardMetrics() {
    try {
      const r = await fetch('/api/admin/dashboard-metrics');
      if (!r.ok) throw new Error('failed');
      const data = await r.json();

      const ram = data.ram || {};
      const network = data.network || {};
      const containers = Array.isArray(data.containers_memory) ? data.containers_memory : [];

      const ramHistory = Array.isArray(ram.history) ? ram.history : [];
      const labels = ramHistory.map((p) => formatTimePoint(p.t));
      const ramSeries = ramHistory.map((p) => safeNumber(p.v));
      const txSeries = (Array.isArray(network.history_tx) ? network.history_tx : []).map((p) => safeNumber(p.v));
      const rxSeries = (Array.isArray(network.history_rx) ? network.history_rx : []).map((p) => safeNumber(p.v));

      ramChart = makeOrUpdateChart(document.getElementById('ramTimelineChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'RAM %',
            data: ramSeries,
            borderColor: '#6f7dff',
            backgroundColor: 'rgba(111, 125, 255, 0.2)',
            fill: true,
            tension: 0.28,
            pointRadius: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { min: 0, max: 100, ticks: { color: '#969fbf' }, grid: { color: 'rgba(255,255,255,0.08)' } },
            x: { ticks: { color: '#969fbf', maxRotation: 0 }, grid: { color: 'rgba(255,255,255,0.04)' } }
          }
        }
      }, ramChart);

      networkChart = makeOrUpdateChart(document.getElementById('networkTimelineChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'TX MB/s',
              data: txSeries,
              borderColor: '#8f9bff',
              backgroundColor: 'rgba(143, 155, 255, 0.13)',
              fill: true,
              tension: 0.25,
              pointRadius: 0,
            },
            {
              label: 'RX MB/s',
              data: rxSeries,
              borderColor: '#fbbf24',
              backgroundColor: 'rgba(251, 191, 36, 0.13)',
              fill: true,
              tension: 0.25,
              pointRadius: 0,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#bdc5e6', boxWidth: 10, boxHeight: 10 }
            }
          },
          scales: {
            y: { ticks: { color: '#969fbf' }, grid: { color: 'rgba(255,255,255,0.08)' } },
            x: { ticks: { color: '#969fbf', maxRotation: 0 }, grid: { color: 'rgba(255,255,255,0.04)' } }
          }
        }
      }, networkChart);

      const topContainers = containers.slice(0, 8);
      const donutLabels = topContainers.map((c) => c.name);
      const donutData = topContainers.map((c) => safeNumber(c.memory_used_mb));
      const diskDonutData = topContainers.map((c) => safeNumber(c.disk_used_mb ?? c.disk_rw_mb));
      const otherMemory = containers.slice(8).reduce((s, c) => s + safeNumber(c.memory_used_mb), 0);
      const otherDisk = containers.slice(8).reduce((s, c) => s + safeNumber(c.disk_used_mb ?? c.disk_rw_mb), 0);
      if (otherMemory > 0.1 || otherDisk > 0.1) {
        donutLabels.push('others');
        donutData.push(otherMemory);
        diskDonutData.push(otherDisk);
      }

      containersChart = makeOrUpdateChart(document.getElementById('containerMemoryChart'), {
        type: 'doughnut',
        data: {
          labels: donutLabels,
          datasets: [{
            data: donutData,
            borderWidth: 1,
            borderColor: 'rgba(8, 11, 18, 0.9)',
            backgroundColor: ['#5865ff', '#7b87ff', '#99a2ff', '#4b8fff', '#6fa7ff', '#7f8cff', '#a1a9ff', '#6f7aff', '#8d97f0']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '58%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#bdc5e6', padding: 12, boxWidth: 10, boxHeight: 10 }
            }
          }
        }
      }, containersChart);

      containerDiskChart = makeOrUpdateChart(document.getElementById('containerDiskChart'), {
        type: 'doughnut',
        data: {
          labels: donutLabels,
          datasets: [{
            data: diskDonutData,
            borderWidth: 1,
            borderColor: 'rgba(8, 11, 18, 0.9)',
            backgroundColor: ['#f59e0b', '#fb923c', '#fbbf24', '#fca5a5', '#fdba74', '#f97316', '#fcd34d', '#fb7185', '#f59e8b']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '58%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#bdc5e6', padding: 12, boxWidth: 10, boxHeight: 10 }
            }
          }
        }
      }, containerDiskChart);

      const ramPercent = safeNumber(ram.percent);
      const ramUsed = safeNumber(ram.used_gb);
      const ramTotal = safeNumber(ram.total_gb);
      document.getElementById('ram-quick').textContent = `${ramUsed.toFixed(1)} / ${ramTotal.toFixed(1)} GB (${ramPercent.toFixed(1)}%)`;

      const tx = safeNumber(network.tx_mbps);
      const rx = safeNumber(network.rx_mbps);
      document.getElementById('network-quick').textContent = `↑ ${tx.toFixed(2)} MB/s  ↓ ${rx.toFixed(2)} MB/s`;

      const totalContainerMb = containers.reduce((s, c) => s + safeNumber(c.memory_used_mb), 0);
      document.getElementById('containers-mem-total').textContent = `${(totalContainerMb / 1024).toFixed(2)} GB`;
      const totalContainerDiskMb = containers.reduce((s, c) => s + safeNumber(c.disk_used_mb ?? c.disk_rw_mb), 0);
      document.getElementById('containers-disk-total').textContent = `${(totalContainerDiskMb / 1024).toFixed(2)} GB`;

      renderDisks(Array.isArray(data.disks) ? data.disks : []);

      const upd = document.getElementById('admin-metrics-updated');
      if (upd) {
        upd.textContent = `updated ${new Date().toLocaleTimeString()}`;
      }
    } catch (_) {
      const upd = document.getElementById('admin-metrics-updated');
      if (upd) upd.textContent = 'telemetry unavailable';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateAdminDashboardMetrics();
    if (window.__nebulaAdminMetricsTimer) {
      clearInterval(window.__nebulaAdminMetricsTimer);
    }
    window.__nebulaAdminMetricsTimer = setInterval(updateAdminDashboardMetrics, 3000);
  });
</script>
{% endif %}
{% endblock %}
