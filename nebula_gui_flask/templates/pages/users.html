{% extends "layout.html" %}
{% block page_content %}
<div class="container-fluid user-management-page" style="padding: 24px;">
    <div class="users-topbar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
        <div class="users-topbar-left" style="display: flex; align-items: center; gap: 24px;">
            <h2 style="font-weight: 700; letter-spacing: -0.5px; margin: 0; color: white;">User Management</h2>
            <div style="position: relative;">
                <i class="bi bi-database" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem;"></i>
                <select id="db_selector" onchange="fetchUsers()" class="premium-select">
                </select>
                <i class="bi bi-chevron-down" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.8rem; pointer-events: none;"></i>
            </div>
        </div>
        <a href="/users/add" class="add-user-btn">
            <i class="bi bi-person-plus-fill"></i>
            <span>Add Member</span>
        </a>
    </div>

    <div class="table-shell">
        <div class="table-card">
            <table class="user-table" style="width: 100%; border-collapse: collapse; text-align: left;">
                <thead>
                    <tr class="table-header-row">
                        <th style="padding: 18px 24px;">Identity</th>
                        <th style="padding: 18px 24px;">Privileges</th>
                        <th style="padding: 18px 24px;">Network Status</th>
                        <th style="padding: 18px 24px; text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="user_table_body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h3 style="margin: 0; font-weight: 700; color: white;">Account Configuration</h3>
                <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: var(--text-muted);">Modify user credentials and system permissions</p>
            </div>
            <button onclick="closeModal()" class="close-modal-btn"><i class="bi bi-x-lg"></i></button>
        </div>

        <div style="padding: 32px;">
            <input type="hidden" id="edit_old_username">
            
            <div class="modal-grid">
                <div class="modal-col">
                    <div class="input-field">
                        <label>User Principal</label>
                        <div class="input-wrapper">
                            <i class="bi bi-person"></i>
                            <input type="text" id="edit_username" placeholder="Username">
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Security Key</label>
                        <div class="input-wrapper">
                            <i class="bi bi-shield-lock"></i>
                            <input type="password" id="edit_password" placeholder="••••••••••••">
                        </div>
                        <span class="input-hint">Leave blank to preserve current key</span>
                    </div>
                </div>

                <div class="modal-col">
                    <div class="input-field">
                        <label>Access Level</label>
                        <div class="input-wrapper">
                            <i class="bi bi-layers"></i>
                            <select id="edit_role">
                            </select>
                        </div>
                    </div>
                    <div class="input-field">
                        <label>Deployment Cluster</label>
                        <div class="input-wrapper">
                            <i class="bi bi-server"></i>
                            <select id="edit_target_db"></select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status-box">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="status-icon-bg">
                        <i class="bi bi-broadcast"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600; font-size: 0.9rem; color: white;">Active Session</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Enable account for network operations</div>
                    </div>
                </div>
                <label class="ios-switch">
                    <input type="checkbox" id="edit_is_active" checked>
                    <span class="ios-slider"></span>
                </label>
            </div>
        </div>

        <div class="modal-footer">
            <button onclick="closeModal()" class="btn-secondary">Discard</button>
            <button onclick="saveUserEdit()" class="btn-primary">Commit Changes</button>
        </div>
    </div>
</div>

<style>
    /* Premium Select & Buttons */
    .premium-select {
        background: #0d0d12; color: var(--text); border: 1px solid var(--border);
        padding: 10px 40px 10px 36px; border-radius: 8px; outline: none;
        cursor: pointer; font-size: 0.9rem; appearance: none; min-width: 220px; transition: 0.2s;
    }
    .premium-select:hover { border-color: var(--accent); }
    .premium-select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(88, 101, 255, 0.16); }

    .add-user-btn {
        padding: 12px 24px; background: var(--accent); color: white;
        text-decoration: none; border-radius: 10px; font-weight: 600;
        font-size: 0.85rem; display: flex; align-items: center; gap: 10px;
        transition: 0.3s; box-shadow: 0 4px 15px rgba(88, 101, 255, 0.3);
    }
    .add-user-btn:hover { background: var(--accent-hover); transform: translateY(-1px); }

    /* Table Styling */
    .table-shell { overflow-x: auto; }
    .table-card { background: var(--card); border-radius: 16px; border: 1px solid var(--border); overflow: visible; }
    .user-table { min-width: 760px; }
    .table-header-row { border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02); }
    .table-header-row th { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); font-weight: 700; }

    /* Modal Core */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center;
        backdrop-filter: blur(12px); animation: fadeIn 0.2s ease;
    }
    .modal-content {
        background: #0d0d12; border: 1px solid var(--border); width: 680px;
        max-width: calc(100vw - 24px); max-height: calc(100vh - 24px);
        border-radius: 24px; box-shadow: 0 40px 80px rgba(0,0,0,0.7); overflow: auto;
    }
    .modal-header { padding: 24px 32px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .close-modal-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
    .close-modal-btn:hover { color: white; }

    /* Modal Body */
    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; }
    .modal-col { display: flex; flex-direction: column; gap: 24px; }
    .input-field label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; margin-bottom: 10px; display: block; }
    .input-wrapper { position: relative; display: flex; align-items: center; }
    .input-wrapper i { position: absolute; left: 16px; color: var(--text-muted); font-size: 1rem; }
    .input-wrapper input, .input-wrapper select {
        width: 100%; padding: 14px 16px 14px 46px; background: #050507;
        border: 1px solid var(--border); border-radius: 12px; color: white;
        outline: none; transition: 0.2s; font-size: 0.9rem;
    }
    .input-wrapper input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(88, 101, 255, 0.15); }
    .input-hint { color: var(--text-muted); font-size: 0.7rem; margin-top: 6px; display: block; }

    /* Status Box & Switch */
    .status-box {
        margin-top: 32px; padding: 20px; background: rgba(255,255,255,0.03);
        border-radius: 16px; display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border);
    }
    .status-icon-bg { width: 42px; height: 42px; background: rgba(88, 101, 255, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--accent); font-size: 1.2rem; }
    
    .ios-switch { position: relative; display: inline-block; width: 48px; height: 26px; }
    .ios-switch input { opacity: 0; width: 0; height: 0; }
    .ios-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #2a2a2e; transition: .4s; border-radius: 34px; }
    .ios-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .ios-slider { background-color: #4ade80; }
    input:checked + .ios-slider:before { transform: translateX(22px); }

    /* Footer Buttons */
    .modal-footer { padding: 24px 32px; background: rgba(255,255,255,0.01); border-top: 1px solid var(--border); display: flex; gap: 16px; justify-content: flex-end; }
    .btn-primary { padding: 14px 32px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }
    .btn-secondary { padding: 14px 24px; background: transparent; color: white; border: 1px solid var(--border); border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-secondary:hover { background: rgba(255,255,255,0.05); }

    /* Action Dropdown */
    .action-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; padding: 8px; transition: 0.2s; border-radius: 8px; }
    .action-btn:hover { background: rgba(255,255,255,0.05); color: white; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content {
        display: none; position: fixed; background: #111114;
        min-width: 240px; border: 1px solid var(--border); border-radius: 12px;
        z-index: 9999; box-shadow: 0 20px 40px rgba(0,0,0,0.8); padding: 8px;
    }
    .dropdown-content a {
        color: var(--text-muted); padding: 12px 14px; text-decoration: none;
        display: flex; align-items: center; gap: 12px; font-size: 0.85rem; transition: 0.2s; border-radius: 8px;
    }
    .dropdown-content a:hover { background: rgba(88, 101, 255, 0.1); color: var(--accent); }
    .show { display: block !important; animation: slideIn 0.2s ease; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
// --- Logic Core ---
let rolesCatalog = [];
let lastUsersPayload = [];

function escapeHtml(value) {
    return String(value ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

function jsQuote(value) {
    return String(value ?? '')
        .replaceAll('\\', '\\\\')
        .replaceAll("'", "\\'")
        .replaceAll('\n', '\\n')
        .replaceAll('\r', '\\r');
}

function safeDomId(value) {
    return String(value ?? '').replace(/[^a-zA-Z0-9_-]/g, '_');
}

async function initPage() {
    try {
        const dbRes = await fetch('/api/users/databases');
        const dbData = await dbRes.json();
        const selector = document.getElementById('db_selector');
        const modalSelector = document.getElementById('edit_target_db');
        
        dbData.databases.forEach(db => {
            const option = document.createElement('option');
            option.value = db; option.textContent = db.toUpperCase();
            selector.appendChild(option);
            modalSelector.appendChild(option.cloneNode(true));
        });
        const rolesRes = await fetch('/api/roles/list');
        const rolesData = await rolesRes.json();
        rolesCatalog = Array.isArray(rolesData) ? rolesData : [];
        const roleSelect = document.getElementById('edit_role');
        roleSelect.innerHTML = '';
        rolesCatalog.forEach(role => {
            const opt = document.createElement('option');
            opt.value = role.name;
            opt.textContent = role.is_staff ? `${role.name} (staff)` : role.name;
            roleSelect.appendChild(opt);
        });
        if (dbData.databases.length > 0) fetchUsers();
    } catch (e) { console.error("Nebula API Error:", e); }
}

async function fetchUsers() {
    const dbName = document.getElementById('db_selector').value;
    const tbody = document.getElementById('user_table_body');
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:80px; color:var(--text-muted);"><i class="bi bi-arrow-repeat spin" style="display:inline-block; font-size:1.5rem; margin-bottom:10px;"></i><br>Syncing Data...</td></tr>';

    try {
        const response = await fetch(`/api/users/list?db_name=${dbName}`);
        const payload = await response.json();
        const users = Array.isArray(payload) ? payload : [];
        lastUsersPayload = users;
        tbody.innerHTML = '';

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:56px 24px; color:var(--text-muted);">No users found in this database.</td></tr>';
            return;
        }
        
        users.forEach(user => {
            const row = document.createElement('tr');
            row.className = "table-row-hover";
            row.style.borderBottom = '1px solid var(--border)';
            const username = String(user.username ?? '');
            const usernameHtml = escapeHtml(username);
            const usernameJs = jsQuote(username);
            const menuSuffix = safeDomId(username);
            const menuId = `drop-${menuSuffix}`;
            const encodedUsername = encodeURIComponent(username);
            row.innerHTML = `
                <td style="padding: 18px 24px;">
                    <div style="display:flex; align-items:center; gap:16px;">
                        <div style="width:40px; height:40px; background:#1a1a1e; border-radius:12px; display:flex; align-items:center; justify-content:center; border:1px solid var(--border);">
                            <i class="bi bi-person-circle" style="color:var(--text-muted); font-size:1.2rem;"></i>
                        </div>
                        <div>
                            <div style="font-weight:700; color:white; font-size:0.9rem;">${usernameHtml}</div>
                            <div style="font-size:0.75rem; color:var(--text-muted);">ID: ${user.id}</div>
                        </div>
                    </div>
                </td>
                <td style="padding: 18px 24px;">
                    <span class="badge ${user.is_staff ? 'badge-admin' : 'badge-user'}">
                        <i class="bi ${user.is_staff ? 'bi-shield-check' : 'bi-person'}"></i>
                        ${(user.role_tag || 'user').toUpperCase()}
                    </span>
                </td>
                <td style="padding: 18px 24px;">
                    <div style="display:flex; align-items:center; gap:10px; color:#4ade80; font-size:0.8rem; font-weight:700;">
                        <div class="pulse-dot"></div> ACTIVE
                    </div>
                </td>
                <td style="padding: 18px 24px; text-align: right;">
                    <div class="dropdown">
                        <button class="action-btn" onclick="toggleMenu(event, '${menuId}')">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <div id="${menuId}" class="dropdown-content">
                            <a href="/users/view/${encodedUsername}?db_name=${encodeURIComponent(dbName)}">
                                <i class="bi bi-shield-shaded"></i> Intelligence Profile
                            </a>
                            <a href="javascript:void(0)" onclick="openEditModal('${usernameJs}')">
                                <i class="bi bi-gear-wide-connected"></i> Full Configuration
                            </a>
                            <a href="javascript:void(0)" onclick="pinUser('${usernameJs}')">
                                <i class="bi bi-pin-angle"></i> Pin to Dashboard
                            </a>
                            <hr style="border: 0; border-top: 1px solid var(--border); margin: 6px 0;">
                            <a href="javascript:void(0)" style="color:#ff6b6b;" onclick="banUser('${usernameJs}')">
                                <i class="bi bi-trash3"></i> Delete Member
                            </a>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (e) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color:#ff4f4f;">Database Connection Lost</td></tr>';
    }
}

// --- Interaction UI ---
function toggleMenu(e, id) {
    e.stopPropagation();
    const menu = document.getElementById(id);
    document.querySelectorAll('.dropdown-content').forEach(d => { if(d !== menu) d.classList.remove('show'); });
    const shouldOpen = !menu.classList.contains('show');
    menu.classList.toggle('show', shouldOpen);
    if (shouldOpen) {
        positionMenu(menu, e.currentTarget || e.target);
    }
}

function positionMenu(menu, trigger) {
    const anchor = trigger?.closest('button') || trigger;
    if (!menu || !anchor) return;
    const rect = anchor.getBoundingClientRect();
    const vpW = window.innerWidth;
    const vpH = window.innerHeight;

    menu.style.left = '-9999px';
    menu.style.top = '-9999px';
    menu.classList.add('show');

    const menuWidth = menu.offsetWidth || 240;
    const menuHeight = menu.offsetHeight || 200;
    const sidePad = 8;
    const gap = 8;

    let left = rect.right - menuWidth;
    if (left < sidePad) left = sidePad;
    if (left + menuWidth > vpW - sidePad) left = vpW - menuWidth - sidePad;

    let top = rect.bottom + gap;
    if (top + menuHeight > vpH - sidePad) {
        top = rect.top - menuHeight - gap;
    }
    if (top < sidePad) top = sidePad;

    menu.style.left = `${Math.round(left)}px`;
    menu.style.top = `${Math.round(top)}px`;
}

function openEditModal(name) {
    document.getElementById('edit_old_username').value = name;
    document.getElementById('edit_username').value = name;
    const userRow = lastUsersPayload.find(u => String(u.username) === String(name));
    const roleTag = userRow?.role_tag || (userRow?.is_staff ? 'admin' : 'user');
    document.getElementById('edit_role').value = roleTag;
    document.getElementById('edit_target_db').value = document.getElementById('db_selector').value;
    document.getElementById('editModal').style.display = 'flex';
}

function closeModal() { document.getElementById('editModal').style.display = 'none'; }

async function saveUserEdit() {
    const payload = {
        old_username: document.getElementById('edit_old_username').value,
        new_username: document.getElementById('edit_username').value,
        new_password: document.getElementById('edit_password').value,
        role_tag: document.getElementById('edit_role').value,
        is_active: document.getElementById('edit_is_active').checked,
        source_db: document.getElementById('db_selector').value,
        target_db: document.getElementById('edit_target_db').value
    };

    const res = await fetch('/api/users/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });

    if(res.ok) { closeModal(); fetchUsers(); } else { alert("Operational Error: DB Locked or Access Denied"); }
}

function pinUser(username) {
    localStorage.setItem('nebula-pinned-user', String(username || '').trim());
    alert(`Pinned: ${username}`);
}

async function banUser(username) {
    const name = String(username || '').trim();
    if (!name) return;
    if (!confirm(`Delete user "${name}"?`)) return;
    const dbName = document.getElementById('db_selector').value;
    const res = await fetch(`/api/users/delete?db_name=${encodeURIComponent(dbName)}&username=${encodeURIComponent(name)}`, {
        method: 'POST'
    });
    const out = await res.json();
    if (!res.ok) {
        alert(out.detail || 'Failed to delete user');
        return;
    }
    await fetchUsers();
}

document.addEventListener('click', (event) => {
    if (!event.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
    }
});
window.addEventListener('resize', () => {
    document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
});
window.addEventListener('scroll', () => {
    document.querySelectorAll('.dropdown-content').forEach(d => d.classList.remove('show'));
}, true);
document.addEventListener('DOMContentLoaded', initPage);

</script>

<style>
    /* Final Polish Styles */
    .badge { padding: 6px 12px; border-radius: 8px; font-size: 0.65rem; font-weight: 800; letter-spacing: 0.5px; display: inline-flex; align-items: center; gap: 6px; }
    .badge-admin { background: rgba(88, 101, 255, 0.1); color: var(--accent); border: 1px solid rgba(88, 101, 255, 0.2); }
    .badge-user { background: rgba(255, 255, 255, 0.05); color: var(--text-muted); border: 1px solid var(--border); }
    
    .pulse-dot { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; box-shadow: 0 0 12px rgba(74, 222, 128, 0.5); }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    .table-row-hover:hover { background: rgba(255,255,255,0.01) !important; }

    @media (max-width: 980px) {
        .user-management-page { padding: 14px !important; }
        .users-topbar {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 14px;
            margin-bottom: 18px !important;
        }
        .users-topbar-left {
            width: 100%;
            flex-direction: column;
            align-items: flex-start !important;
            gap: 10px !important;
        }
        .premium-select { min-width: 190px; }
        .modal-grid { grid-template-columns: 1fr; gap: 18px; }
        .modal-content { border-radius: 16px; }
        .modal-header, .modal-footer { padding: 16px 18px; }
    }
</style>
{% endblock %}
